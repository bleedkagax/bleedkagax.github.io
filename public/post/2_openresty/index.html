<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Openresty | Kaga Blog</title>
<meta name=keywords content="SystemDesign"><meta name=description content="Introduction to OpenResty
OpenResty is a dynamic web platform that integrates Nginx with the powerful Lua scripting language. It is designed to build scalable web applications, web services, and dynamic web gateways. By combining the high performance of Nginx with the flexibility of Lua, OpenResty enables developers to handle complex processing at the edge of the network.
What is OpenResty?
OpenResty extends Nginx by bundling it with a set of powerful Lua libraries and modules (known as LuaJIT). This allows embedding Lua scripts directly into the Nginx configuration, offering unparalleled flexibility for customizing request handling, routing, and response generation."><meta name=author content><link rel=canonical href=https://bleedkagax.github.io/post/2_openresty/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://bleedkagax.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bleedkagax.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bleedkagax.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://bleedkagax.github.io/apple-touch-icon.png><link rel=mask-icon href=https://bleedkagax.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://bleedkagax.github.io/post/2_openresty/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Openresty"><meta property="og:description" content="Introduction to OpenResty
OpenResty is a dynamic web platform that integrates Nginx with the powerful Lua scripting language. It is designed to build scalable web applications, web services, and dynamic web gateways. By combining the high performance of Nginx with the flexibility of Lua, OpenResty enables developers to handle complex processing at the edge of the network.
What is OpenResty?
OpenResty extends Nginx by bundling it with a set of powerful Lua libraries and modules (known as LuaJIT). This allows embedding Lua scripts directly into the Nginx configuration, offering unparalleled flexibility for customizing request handling, routing, and response generation."><meta property="og:type" content="article"><meta property="og:url" content="https://bleedkagax.github.io/post/2_openresty/"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-10-15T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Openresty"><meta name=twitter:description content="Introduction to OpenResty
OpenResty is a dynamic web platform that integrates Nginx with the powerful Lua scripting language. It is designed to build scalable web applications, web services, and dynamic web gateways. By combining the high performance of Nginx with the flexibility of Lua, OpenResty enables developers to handle complex processing at the edge of the network.
What is OpenResty?
OpenResty extends Nginx by bundling it with a set of powerful Lua libraries and modules (known as LuaJIT). This allows embedding Lua scripts directly into the Nginx configuration, offering unparalleled flexibility for customizing request handling, routing, and response generation."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bleedkagax.github.io/post/"},{"@type":"ListItem","position":2,"name":"Openresty","item":"https://bleedkagax.github.io/post/2_openresty/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Openresty","name":"Openresty","description":"Introduction to OpenResty OpenResty is a dynamic web platform that integrates Nginx with the powerful Lua scripting language. It is designed to build scalable web applications, web services, and dynamic web gateways. By combining the high performance of Nginx with the flexibility of Lua, OpenResty enables developers to handle complex processing at the edge of the network.\nWhat is OpenResty? OpenResty extends Nginx by bundling it with a set of powerful Lua libraries and modules (known as LuaJIT). This allows embedding Lua scripts directly into the Nginx configuration, offering unparalleled flexibility for customizing request handling, routing, and response generation.\n","keywords":["SystemDesign"],"articleBody":"Introduction to OpenResty OpenResty is a dynamic web platform that integrates Nginx with the powerful Lua scripting language. It is designed to build scalable web applications, web services, and dynamic web gateways. By combining the high performance of Nginx with the flexibility of Lua, OpenResty enables developers to handle complex processing at the edge of the network.\nWhat is OpenResty? OpenResty extends Nginx by bundling it with a set of powerful Lua libraries and modules (known as LuaJIT). This allows embedding Lua scripts directly into the Nginx configuration, offering unparalleled flexibility for customizing request handling, routing, and response generation.\nKey Features High Performance: Leverages Nginx’s event-driven architecture and LuaJIT’s speed for efficient request handling. Flexibility: Lua scripting enables dynamic content generation, complex routing, and custom logic. Extensibility: Easily integrates with various databases, caching systems, and other backend services. Modular Architecture: OpenResty modules simplify common tasks like routing, authentication, and data processing. Prerequisites Before diving into OpenResty, ensure you have the following:\nBasic Knowledge of Nginx: Understanding Nginx’s configuration and request-handling mechanisms. Familiarity with Lua: Basic knowledge of Lua programming language. Development Environment: Access to a Unix-based system (e.g., Linux or macOS) or Windows with a compatible environment. Installation Installing Dependencies Depending on your operating system, you may need to install certain dependencies before installing OpenResty.\nFor Ubuntu/Debian sudo apt-get update sudo apt-get install -y curl gnupg2 ca-certificates lsb-release For macOS Use Homebrew to install dependencies.\nbrew update brew install curl Installing OpenResty Using Official Packages (Recommended) For Ubuntu/Debian:\nAdd the OpenResty Repository:\nsudo apt-get install -y software-properties-common sudo add-apt-repository -y \"deb https://openresty.org/package/ubuntu $(lsb_release -sc) main\" Add the OpenResty GPG Key:\nwget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add - Update the Package List and Install:\nsudo apt-get update sudo apt-get install -y openresty For macOS:\nUse Homebrew to install OpenResty.\nbrew install openresty/tap/openresty Building from Source Download the Source Code:\nwget https://openresty.org/download/openresty-VERSION.tar.gz tar zxvf openresty-VERSION.tar.gz cd openresty-VERSION/ Replace VERSION with the latest version number.\nConfigure and Compile:\n./configure --with-luajit make sudo make install Verifying Installation Check the installed OpenResty version.\nopenresty -v You should see output similar to:\nnginx version: openresty/1.19.3.1 Basic Configuration Understanding OpenResty’s Architecture OpenResty maintains Nginx’s event-driven, asynchronous architecture while introducing Lua scripting capabilities. The primary components include:\nNginx Core: Handles HTTP server functionality. LuaJIT: A Just-In-Time Compiler for Lua, providing high-speed execution. ngx_lua Module: Embeds Lua into Nginx’s request-processing phases. Additional Modules: OpenResty bundles various modules for enhanced functionality. Configuring Nginx with Lua The configuration files for OpenResty are similar to standard Nginx configurations but include Lua directives.\nExample Configuration (/usr/local/openresty/nginx/conf/nginx.conf):\nworker_processes 1; events { worker_connections 1024; } http { include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; server { listen 8080; server_name localhost; location / { default_type 'text/plain'; content_by_lua_block { ngx.say('Hello, OpenResty!') } } } } Starting OpenResty Use the following command to start the OpenResty server:\nsudo openresty -c /usr/local/openresty/nginx/conf/nginx.conf Visit http://localhost:8080/ in your browser to see the “Hello, OpenResty!” message.\nHello World Example Let’s create a simple “Hello, World!” application using OpenResty.\nStep 1: Create a Configuration File Create a new configuration file or edit the existing one.\nsudo nano /usr/local/openresty/nginx/conf/nginx.conf Step 2: Add Lua Content Insert the following content within the server block.\nserver { listen 8080; server_name localhost; location /hello { default_type 'text/plain'; content_by_lua_block { ngx.say('Hello, World from OpenResty!') } } } Step 3: Restart OpenResty sudo openresty -s reload -c /usr/local/openresty/nginx/conf/nginx.conf Step 4: Test the Endpoint Navigate to http://localhost:8080/hello to see the message.\nHandling Web Requests OpenResty excels at handling web requests with Lua scripts. Let’s explore routing and processing different HTTP methods.\nRouting with Lua Implement dynamic routing using Lua.\nExample:\nserver { listen 8080; server_name localhost; location /api { content_by_lua_block { local request_path = ngx.var.uri if request_path == \"/api/users\" then ngx.say(\"User List\") elseif request_path == \"/api/orders\" then ngx.say(\"Order List\") else ngx.status = 404 ngx.say(\"Not Found\") end } } } Processing HTTP Methods Handle different HTTP methods (GET, POST, PUT, DELETE).\nExample:\nserver { listen 8080; server_name localhost; location /api/resource { content_by_lua_block { local method = ngx.req.get_method() if method == \"GET\" then ngx.say(\"Handling GET request\") elseif method == \"POST\" then ngx.say(\"Handling POST request\") elseif method == \"PUT\" then ngx.say(\"Handling PUT request\") elseif method == \"DELETE\" then ngx.say(\"Handling DELETE request\") else ngx.status = 405 ngx.say(\"Method Not Allowed\") end } } } Working with Lua in OpenResty Lua Modules and Libraries Leverage Lua modules to organize and reuse code.\nExample: Creating a Lua Module (/usr/local/openresty/lualib/my_module.lua):\n-- my_module.lua local _M = {} function _M.greet(name) return \"Hello, \" .. name .. \"!\" end return _M Using the Module in Nginx Configuration:\nserver { listen 8080; server_name localhost; location /greet { default_type 'text/plain'; content_by_lua_block { local my_module = require \"my_module\" local message = my_module.greet(\"OpenResty\") ngx.say(message) } } } Impact of LuaJIT LuaJIT is a Just-In-Time Compiler for Lua, providing significant performance improvements.\nBenefits:\nSpeed: Lua code runs at speeds comparable to C. Efficiency: Enables writing high-performance applications without sacrificing ease of development. Memory Management: Efficient memory usage, crucial for high-concurrency environments. Considerations:\nCompatibility: Ensure LuaJIT is compatible with the Lua code and libraries you intend to use. Limitations: Certain Lua features might be less efficient or unsupported; refer to LuaJIT documentation for specifics. Interacting with Databases OpenResty seamlessly integrates with databases using Lua libraries.\nConnecting to MySQL Use the lua-resty-mysql library to interact with MySQL databases.\nInstallation:\nEnsure you have LuaRocks installed, then install the library.\nsudo luarocks install lua-resty-mysql Configuration Example:\nserver { listen 8080; server_name localhost; location /users { content_by_lua_block { local mysql = require \"resty.mysql\" local db, err = mysql:new() if not db then ngx.say(\"Failed to instantiate mysql: \", err) return end db:set_timeout(1000) -- 1 sec local ok, err, errno, sqlstate = db:connect{ host = \"127.0.0.1\", port = 3306, database = \"test_db\", user = \"test_user\", password = \"test_pass\", charset = \"utf8\", max_packet_size = 1048576, } if not ok then ngx.say(\"Failed to connect: \", err, \": \", errno, \" \", sqlstate) return end local res, err, errno, sqlstate = db:query(\"SELECT * FROM users\") if not res then ngx.say(\"Bad result: \", err, \": \", errno, \": \", sqlstate, \".\") return end -- Put it into the connection pool of size 100, -- with 10 seconds max idle time local ok, err = db:set_keepalive(10000, 100) if not ok then ngx.say(\"Failed to set keepalive: \", err) return end ngx.say(vim.inspect(res)) } } } Explanation:\nInstantiate MySQL Object: Create a new MySQL instance. Set Timeout: Define a timeout for the connection. Connect to Database: Provide necessary connection parameters. Execute Query: Perform SQL queries and handle results. Connection Pooling: Use set_keepalive to reuse connections. Connecting to Redis Use the lua-resty-redis library to interact with Redis.\nInstallation:\nsudo luarocks install lua-resty-redis Configuration Example:\nserver { listen 8080; server_name localhost; location /cache { content_by_lua_block { local redis = require \"resty.redis\" local red = redis:new() red:set_timeout(1000) -- 1 sec local ok, err = red:connect(\"127.0.0.1\", 6379) if not ok then ngx.say(\"Failed to connect: \", err) return end -- Optional: authenticate local res, err = red:auth(\"your_password\") if not res then ngx.say(\"Failed to authenticate: \", err) return end -- Set a key ok, err = red:set(\"my_key\", \"Hello, Redis!\") if not ok then ngx.say(\"Failed to set key: \", err) return end -- Get the key res, err = red:get(\"my_key\") if not res then ngx.say(\"Failed to get key: \", err) return end if res == ngx.null then ngx.say(\"Key not found.\") return end ngx.say(\"Retrieved from Redis: \", res) -- Put it into the connection pool of size 100, -- with 10 seconds max idle time local ok, err = red:set_keepalive(10000, 100) if not ok then ngx.say(\"Failed to set keepalive: \", err) return end } } } Explanation:\nInstantiate Redis Object: Create a new Redis instance. Set Timeout: Define a timeout for the connection. Connect to Redis Server: Provide Redis server address and port. Authenticate (Optional): Authenticate if Redis requires a password. Execute Commands: Perform Redis commands like SET and GET. Connection Pooling: Reuse connections using set_keepalive. Caching Strategies Implementing effective caching strategies can significantly enhance your application’s performance.\nUsing Lua for Caching Store frequently accessed data in memory to reduce database load.\nExample: Caching User Data\nserver { listen 8080; server_name localhost; location /user { content_by_lua_block { local redis = require \"resty.redis\" local cjson = require \"cjson\" local red = redis:new() red:set_timeout(1000) -- Connect to Redis local ok, err = red:connect(\"127.0.0.1\", 6379) if not ok then ngx.log(ngx.ERR, \"Failed to connect to Redis: \", err) ngx.exit(500) end -- Try to get user data from Redis local user_id = ngx.var.arg_id if not user_id then ngx.say(\"User ID not provided\") return end local res, err = red:get(\"user:\" .. user_id) if res == ngx.null then -- Data not in cache, fetch from database (simulated) local user_data = { id = user_id, name = \"John Doe\", email = \"john.doe@example.com\" } -- Simulate database delay ngx.sleep(0.1) -- Store in Redis with TTL of 60 seconds red:setex(\"user:\" .. user_id, 60, cjson.encode(user_data)) ngx.say(cjson.encode(user_data)) else -- Data found in cache ngx.say(res) end -- Set keepalive local ok, err = red:set_keepalive(10000, 100) if not ok then ngx.log(ngx.ERR, \"Failed to set keepalive: \", err) return end } } } Explanation:\nAttempt to Retrieve Data from Redis: Check if user data is present in the Redis cache. Fetch from Database if Cache Miss: If not found, retrieve from the database (simulated here). Store Fetched Data in Redis: Cache the retrieved data with an expiration time (TTL). Respond to Client: Return the user data, either from cache or database. Utilizing Nginx Caching Leverage Nginx’s built-in caching mechanisms for static and dynamic content.\nExample: Caching Responses with proxy_cache\nhttp { proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m use_temp_path=off; server { listen 8080; server_name localhost; location /api { proxy_cache my_cache; proxy_pass http://backend_server; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; # Cache based on query parameters proxy_cache_key \"$scheme$request_method$host$request_uri\"; # Cache validity proxy_cache_valid 200 302 10m; proxy_cache_valid 404 1m; } } } Explanation:\nDefine Cache Path and Zone: Configure where and how Nginx stores cached data. Enable Caching in Location Block: Apply caching to specific routes or endpoints. Set Cache Keys: Define how cache entries are identified. Specify Cache Validity: Determine how long different response statuses are cached. Security Best Practices Ensuring the security of your OpenResty applications is paramount. Implement the following best practices to safeguard your applications.\nInput Validation Always validate and sanitize user inputs to prevent injections and other attacks.\nExample: Validating Query Parameters\nserver { listen 8080; server_name localhost; location /search { content_by_lua_block { local args = ngx.req.get_uri_args() local query = args.query if not query or #query \u003c 3 then ngx.status = 400 ngx.say(\"Invalid query parameter\") return end -- Proceed with processing ngx.say(\"Search results for: \", query) } } } Securing Lua Scripts Restrict access to Lua scripts and handle errors gracefully.\nExample: Error Handling in Lua\nserver { listen 8080; server_name localhost; error_page 500 502 503 504 /50x.html; location = /50x.html { root /usr/share/nginx/html; } location /data { content_by_lua_block { local status, err = pcall(function() -- Your Lua code here error(\"Simulated error\") end) if not status then ngx.log(ngx.ERR, \"Lua error: \", err) ngx.status = 500 ngx.say(\"Internal Server Error\") end } } } Rate Limiting Prevent abuse by limiting the number of requests a client can make.\nExample: Implementing Rate Limiting with Lua\nhttp { lua_shared_dict limits 10m; server { listen 8080; server_name localhost; location /api/ { access_by_lua_block { local limit = require \"resty.limit.req\" local lim, err = limit.new(\"limits\", 100, 200) -- 100 requests per second with burst of 200 if not lim then ngx.log(ngx.ERR, \"failed to instantiate a resty.limit.req object: \", err) return ngx.exit(500) end local key = ngx.var.binary_remote_addr local delay, err = lim:incoming(key, true) if not delay then if err == \"rejected\" then return ngx.exit(429) end ngx.log(ngx.ERR, \"failed to limit request: \", err) return ngx.exit(500) end if delay \u003e= 0.001 then ngx.sleep(delay) end } proxy_pass http://backend_server; } } } Explanation:\nDefine Shared Dictionary: Allocate shared memory for storing rate-limiting data. Instantiate Rate Limiter: Use resty.limit.req to set request limits. Identify Clients: Use client’s IP address as the identifier. Enforce Limits: Allow or reject requests based on defined thresholds. Performance Optimization Optimize your OpenResty applications to handle high traffic efficiently.\nEfficient Lua Coding Write optimized Lua code to reduce execution time and memory usage.\nExample: Avoiding Unnecessary Table Creations\n-- Inefficient local function generate_users(n) local users = {} for i = 1, n do users[i] = {id = i, name = \"User\" .. i} end return users end -- Efficient local function generate_users(n) local users = {} for i = 1, n do users[i] = {id = i, name = \"User\" .. i} end return users end (Note: The above example shows a common pattern; optimize further as needed.)\nNginx Optimization Tweak Nginx settings for better performance.\nExample: Increasing Worker Connections\nworker_processes auto; events { worker_connections 4096; multi_accept on; } Explanation:\nworker_processes auto: Automatically sets the number of worker processes based on available CPU cores. worker_connections: Increases the number of simultaneous connections each worker can handle. multi_accept on: Workers accept all new connections at once, improving connection handling under heavy load. Debugging and Logging Effective debugging and logging are essential for maintaining and troubleshooting applications.\nSetting Up Logging Configure Nginx and Lua to log important events and errors.\nNginx Logging Configuration:\nhttp { log_format main '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" \"$http_x_forwarded_for\"'; access_log /var/log/nginx/access.log main; error_log /var/log/nginx/error.log warn; server { listen 8080; server_name localhost; location / { content_by_lua_block { ngx.log(ngx.INFO, \"Handling request to /\") ngx.say(\"Hello, OpenResty!\") } } } } Lua Logging:\nUse ngx.log to log messages at various levels (DEBUG, INFO, WARN, ERR, etc.).\nngx.log(ngx.INFO, \"This is an informational message\") ngx.log(ngx.ERR, \"This is an error message\") Debugging Lua Scripts Use LuaJIT’s built-in debugging tools and external libraries.\nUsing debug Library:\ncontent_by_lua_block { local function faulty_function() error(\"Something went wrong!\") end local status, err = pcall(faulty_function) if not status then ngx.log(ngx.ERR, \"Error: \", err) ngx.status = 500 ngx.say(\"Internal Server Error\") end } External Libraries:\nLua Inspect: For inspecting variables and data structures. Mobdebug: For remote debugging with zero-brain. Example: Remote Debugging with Mobdebug\nInstall Mobdebug:\nluarocks install mobdebug Configure Lua Code:\ncontent_by_lua_block { local mobdebug = require \"mobdebug\" mobdebug.listen() -- Wait for debugger to connect -- Your Lua code here ngx.say(\"Debugging OpenResty with Mobdebug\") } Connect Debugger:\nUse an IDE like ZeroBrane Studio to connect to Mobdebug.\nDeployment Deploy OpenResty applications efficiently to production environments.\nPreparing for Production Optimize Configuration:\nDisable unnecessary modules and logging. Fine-tune worker processes and connections. Secure the Server:\nUse HTTPS with TLS certificates. Implement firewall rules and security groups. Test Thoroughly:\nPerform load testing and stress testing. Ensure all functionalities work as expected. Managing Configuration Use environment variables and separate configuration files for different environments.\nExample: Using Environment Variables in Lua\ncontent_by_lua_block { local db_host = os.getenv(\"DB_HOST\") or \"127.0.0.1\" local db_port = tonumber(os.getenv(\"DB_PORT\")) or 3306 ngx.say(\"Database Host: \", db_host) ngx.say(\"Database Port: \", db_port) } Continuous Integration and Deployment (CI/CD) Automate the build, test, and deployment processes using CI/CD tools.\nExample: GitLab CI Configuration (.gitlab-ci.yml):\nstages: - build - test - deploy build: stage: build script: - echo \"Building OpenResty application...\" - # Add build commands here artifacts: paths: - build/ test: stage: test script: - echo \"Running tests...\" - # Add test commands here deploy: stage: deploy script: - echo \"Deploying to production...\" - ssh user@server \"sudo systemctl restart openresty\" only: - master Advanced Topics Microservices with OpenResty Leverage OpenResty for building microservices architectures.\nKey Considerations:\nService Isolation: Each microservice should handle a specific functionality. Inter-Service Communication: Use HTTP/HTTPS, gRPC, or message queues (e.g., Kafka) for communication between services. Service Discovery: Implement service discovery mechanisms to manage dynamic service instances. Load Balancing: Utilize Nginx’s load balancing features or service meshes like Istio. Example: Building a Simple Microservice\nserver { listen 8080; server_name localhost; location /service1 { content_by_lua_block { -- Service 1 logic ngx.say(\"Response from Service 1\") } } location /service2 { content_by_lua_block { -- Service 2 logic ngx.say(\"Response from Service 2\") } } } WebSockets Integration Enable real-time communication using WebSockets.\nExample: Handling WebSockets with Lua\nInstall lua-resty-websocket:\nsudo luarocks install lua-resty-websocket Configuration:\nserver { listen 8080; server_name localhost; location /ws { content_by_lua_block { local websocket = require \"resty.websocket.server\" local wb, err = websocket:new{ timeout = 5000, -- in milliseconds max_payload_len = 65535 } if not wb then ngx.log(ngx.ERR, \"Failed to new websocket: \", err) return ngx.exit(444) end while true do local data, typ, err = wb:recv_frame() if not data then if err ~= \"timeout\" then ngx.log(ngx.ERR, \"Failed to receive frame: \", err) wb:send_close(1002, \"Failed to receive frame\") end return end if typ == \"close\" then local bytes, err = wb:send_close(1000) if not bytes then ngx.log(ngx.ERR, \"Failed to send close: \", err) end return elseif typ == \"ping\" then local bytes, err = wb:send_pong() if not bytes then ngx.log(ngx.ERR, \"Failed to send pong: \", err) end elseif typ == \"pong\" then -- handle pong elseif typ == \"text\" then -- Echo the received message local bytes, err = wb:send_text(data) if not bytes then ngx.log(ngx.ERR, \"Failed to send text: \", err) return end elseif typ == \"binary\" then -- Handle binary data if needed end end } } } Explanation:\nEstablish WebSocket Connection: Upgrade the HTTP request to a WebSocket connection. Handle Frames: Receive and respond to different frame types (text, binary, ping, pong, close). Echo Messages: Echo back received text messages for demonstration. API Gateway with OpenResty Use OpenResty as an API Gateway to manage, route, and secure API traffic.\nKey Features:\nRouting and Load Balancing: Direct requests to appropriate backend services. Authentication and Authorization: Implement security measures to protect APIs. Rate Limiting: Control the rate of incoming requests. Caching and Compression: Optimize performance by caching responses and compressing data. Example: Simple API Gateway Configuration\nhttp { lua_shared_dict limits 10m; proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off; server { listen 8080; server_name localhost; location /api/service1 { proxy_pass http://service1_backend; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; # Caching proxy_cache my_cache; proxy_cache_valid 200 302 10m; proxy_cache_valid 404 1m; } location /api/service2 { proxy_pass http://service2_backend; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; # Rate Limiting access_by_lua_block { -- Implement rate limiting logic } } location /auth { access_by_lua_block { -- Implement authentication logic } proxy_pass http://auth_backend; } } } Explanation:\nRouting: Direct API requests to respective backend services. Caching: Cache responses from service1_backend to improve performance. Rate Limiting: Apply rate limiting on service2_backend. Authentication: Add authentication checks for sensitive endpoints. Resources and Further Reading Official Documentation OpenResty Official Site: https://openresty.org/ OpenResty GitHub Repository: https://github.com/openresty/openresty LuaJIT Documentation: https://luajit.org/ lua-resty Libraries: https://github.com/openresty/lua-resty-* Books and Articles “OpenResty: High Performance Web Platform Using Lua” by Jay Huang “Programming OpenResty” by Noel Rappin “Mastering OpenResty” by Dr. Mai Phan and Jay Huang Online Tutorials and Courses OpenResty Tutorial by OpenResty.org: https://openresty.org/en/ OpenResty Introduction on DigitalOcean: https://www.digitalocean.com/community/tutorials/how-to-install-openresty-on-ubuntu-18-04 YouTube Video Tutorials: OpenResty Course - Understanding the Basics Advanced OpenResty Configurations Community and Support OpenResty Mailing List: Subscribe to stay updated with the latest news and updates. OpenResty Forums: Participate in discussions and seek help from the community. Stack Overflow: Tag questions with openresty or lua to get assistance. Gophers Slack: Join the Gophers Slack Workspace for real-time discussions and support. Conclusion OpenResty is a powerful platform that combines the robust capabilities of Nginx with the flexibility of Lua scripting. This comprehensive tutorial has walked you through the essentials of setting up, configuring, and optimizing OpenResty for various web applications. By mastering OpenResty, you can build high-performance, scalable, and secure web services tailored to your specific needs.\nRemember, the key to proficiency is consistent practice and active participation in the community. Leverage the resources provided, experiment with different configurations, and contribute to open-source projects to deepen your understanding and expertise in OpenResty.\nHappy Coding!\n","wordCount":"3248","inLanguage":"en","datePublished":"2024-10-15T00:00:00Z","dateModified":"2024-10-15T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://bleedkagax.github.io/post/2_openresty/"},"publisher":{"@type":"Organization","name":"Kaga Blog","logo":{"@type":"ImageObject","url":"https://bleedkagax.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bleedkagax.github.io/ accesskey=h title="Kaga Blog (Alt + H)">Kaga Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Openresty</h1><div class=post-meta><span title='2024-10-15 00:00:00 +0000 UTC'>October 15, 2024</span></div></header><div class=post-content><h2 id=introduction-to-openresty>Introduction to OpenResty<a hidden class=anchor aria-hidden=true href=#introduction-to-openresty>#</a></h2><p>OpenResty is a dynamic web platform that integrates Nginx with the powerful Lua scripting language. It is designed to build scalable web applications, web services, and dynamic web gateways. By combining the high performance of Nginx with the flexibility of Lua, OpenResty enables developers to handle complex processing at the edge of the network.</p><h2 id=what-is-openresty>What is OpenResty?<a hidden class=anchor aria-hidden=true href=#what-is-openresty>#</a></h2><p>OpenResty extends Nginx by bundling it with a set of powerful Lua libraries and modules (known as LuaJIT). This allows embedding Lua scripts directly into the Nginx configuration, offering unparalleled flexibility for customizing request handling, routing, and response generation.</p><h3 id=key-features>Key Features<a hidden class=anchor aria-hidden=true href=#key-features>#</a></h3><ul><li><strong>High Performance:</strong> Leverages Nginx&rsquo;s event-driven architecture and LuaJIT&rsquo;s speed for efficient request handling.</li><li><strong>Flexibility:</strong> Lua scripting enables dynamic content generation, complex routing, and custom logic.</li><li><strong>Extensibility:</strong> Easily integrates with various databases, caching systems, and other backend services.</li><li><strong>Modular Architecture:</strong> OpenResty modules simplify common tasks like routing, authentication, and data processing.</li></ul><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><p>Before diving into OpenResty, ensure you have the following:</p><ul><li><strong>Basic Knowledge of Nginx:</strong> Understanding Nginx’s configuration and request-handling mechanisms.</li><li><strong>Familiarity with Lua:</strong> Basic knowledge of Lua programming language.</li><li><strong>Development Environment:</strong> Access to a Unix-based system (e.g., Linux or macOS) or Windows with a compatible environment.</li></ul><h2 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h2><h3 id=installing-dependencies>Installing Dependencies<a hidden class=anchor aria-hidden=true href=#installing-dependencies>#</a></h3><p>Depending on your operating system, you may need to install certain dependencies before installing OpenResty.</p><h4 id=for-ubuntudebian>For Ubuntu/Debian<a hidden class=anchor aria-hidden=true href=#for-ubuntudebian>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y curl gnupg2 ca-certificates lsb-release
</span></span></code></pre></div><h4 id=for-macos>For macOS<a hidden class=anchor aria-hidden=true href=#for-macos>#</a></h4><p>Use <a href=https://brew.sh/>Homebrew</a> to install dependencies.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew update
</span></span><span style=display:flex><span>brew install curl
</span></span></code></pre></div><h3 id=installing-openresty>Installing OpenResty<a hidden class=anchor aria-hidden=true href=#installing-openresty>#</a></h3><h4 id=using-official-packages-recommended>Using Official Packages (Recommended)<a hidden class=anchor aria-hidden=true href=#using-official-packages-recommended>#</a></h4><p><strong>For Ubuntu/Debian:</strong></p><ol><li><p><strong>Add the OpenResty Repository:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install -y software-properties-common
</span></span><span style=display:flex><span>sudo add-apt-repository -y <span style=color:#e6db74>&#34;deb https://openresty.org/package/ubuntu </span><span style=color:#66d9ef>$(</span>lsb_release -sc<span style=color:#66d9ef>)</span><span style=color:#e6db74> main&#34;</span>
</span></span></code></pre></div></li><li><p><strong>Add the OpenResty GPG Key:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget -qO - https://openresty.org/package/pubkey.gpg | sudo apt-key add -
</span></span></code></pre></div></li><li><p><strong>Update the Package List and Install:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y openresty
</span></span></code></pre></div></li></ol><p><strong>For macOS:</strong></p><p>Use Homebrew to install OpenResty.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install openresty/tap/openresty
</span></span></code></pre></div><h4 id=building-from-source>Building from Source<a hidden class=anchor aria-hidden=true href=#building-from-source>#</a></h4><ol><li><p><strong>Download the Source Code:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://openresty.org/download/openresty-VERSION.tar.gz
</span></span><span style=display:flex><span>tar zxvf openresty-VERSION.tar.gz
</span></span><span style=display:flex><span>cd openresty-VERSION/
</span></span></code></pre></div><p>Replace <code>VERSION</code> with the latest version number.</p></li><li><p><strong>Configure and Compile:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure --with-luajit
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div></li></ol><h3 id=verifying-installation>Verifying Installation<a hidden class=anchor aria-hidden=true href=#verifying-installation>#</a></h3><p>Check the installed OpenResty version.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openresty -v
</span></span></code></pre></div><p>You should see output similar to:</p><pre tabindex=0><code>nginx version: openresty/1.19.3.1
</code></pre><h2 id=basic-configuration>Basic Configuration<a hidden class=anchor aria-hidden=true href=#basic-configuration>#</a></h2><h3 id=understanding-openrestys-architecture>Understanding OpenResty’s Architecture<a hidden class=anchor aria-hidden=true href=#understanding-openrestys-architecture>#</a></h3><p>OpenResty maintains Nginx&rsquo;s event-driven, asynchronous architecture while introducing Lua scripting capabilities. The primary components include:</p><ul><li><strong>Nginx Core:</strong> Handles HTTP server functionality.</li><li><strong>LuaJIT:</strong> A Just-In-Time Compiler for Lua, providing high-speed execution.</li><li><strong>ngx_lua Module:</strong> Embeds Lua into Nginx’s request-processing phases.</li><li><strong>Additional Modules:</strong> OpenResty bundles various modules for enhanced functionality.</li></ul><h3 id=configuring-nginx-with-lua>Configuring Nginx with Lua<a hidden class=anchor aria-hidden=true href=#configuring-nginx-with-lua>#</a></h3><p>The configuration files for OpenResty are similar to standard Nginx configurations but include Lua directives.</p><p><strong>Example Configuration (<code>/usr/local/openresty/nginx/conf/nginx.conf</code>):</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>worker_processes</span>  <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>worker_connections</span>  <span style=color:#ae81ff>1024</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>include</span>       <span style=color:#e6db74>mime.types</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>default_type</span>  <span style=color:#e6db74>application/octet-stream</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sendfile</span>        <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>keepalive_timeout</span>  <span style=color:#ae81ff>65</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>default_type</span> <span style=color:#e6db74>&#39;text/plain&#39;</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>                <span style=color:#f92672>ngx.say(&#39;Hello,</span> <span style=color:#e6db74>OpenResty!&#39;)</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=starting-openresty>Starting OpenResty<a hidden class=anchor aria-hidden=true href=#starting-openresty>#</a></h3><p>Use the following command to start the OpenResty server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo openresty -c /usr/local/openresty/nginx/conf/nginx.conf
</span></span></code></pre></div><p>Visit <code>http://localhost:8080/</code> in your browser to see the &ldquo;Hello, OpenResty!&rdquo; message.</p><h2 id=hello-world-example>Hello World Example<a hidden class=anchor aria-hidden=true href=#hello-world-example>#</a></h2><p>Let’s create a simple &ldquo;Hello, World!&rdquo; application using OpenResty.</p><h3 id=step-1-create-a-configuration-file>Step 1: Create a Configuration File<a hidden class=anchor aria-hidden=true href=#step-1-create-a-configuration-file>#</a></h3><p>Create a new configuration file or edit the existing one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /usr/local/openresty/nginx/conf/nginx.conf
</span></span></code></pre></div><h3 id=step-2-add-lua-content>Step 2: Add Lua Content<a hidden class=anchor aria-hidden=true href=#step-2-add-lua-content>#</a></h3><p>Insert the following content within the <code>server</code> block.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/hello</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>default_type</span> <span style=color:#e6db74>&#39;text/plain&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>ngx.say(&#39;Hello,</span> <span style=color:#e6db74>World</span> <span style=color:#e6db74>from</span> <span style=color:#e6db74>OpenResty!&#39;)</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=step-3-restart-openresty>Step 3: Restart OpenResty<a hidden class=anchor aria-hidden=true href=#step-3-restart-openresty>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo openresty -s reload -c /usr/local/openresty/nginx/conf/nginx.conf
</span></span></code></pre></div><h3 id=step-4-test-the-endpoint>Step 4: Test the Endpoint<a hidden class=anchor aria-hidden=true href=#step-4-test-the-endpoint>#</a></h3><p>Navigate to <code>http://localhost:8080/hello</code> to see the message.</p><h2 id=handling-web-requests>Handling Web Requests<a hidden class=anchor aria-hidden=true href=#handling-web-requests>#</a></h2><p>OpenResty excels at handling web requests with Lua scripts. Let’s explore routing and processing different HTTP methods.</p><h3 id=routing-with-lua>Routing with Lua<a hidden class=anchor aria-hidden=true href=#routing-with-lua>#</a></h3><p>Implement dynamic routing using Lua.</p><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/api</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>request_path</span> = <span style=color:#e6db74>ngx.var.uri</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>request_path</span> == <span style=color:#e6db74>&#34;/api/users&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;User</span> <span style=color:#e6db74>List&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>request_path</span> == <span style=color:#e6db74>&#34;/api/orders&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Order</span> <span style=color:#e6db74>List&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>else</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.status</span> = <span style=color:#ae81ff>404</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Not</span> <span style=color:#e6db74>Found&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=processing-http-methods>Processing HTTP Methods<a hidden class=anchor aria-hidden=true href=#processing-http-methods>#</a></h3><p>Handle different HTTP methods (GET, POST, PUT, DELETE).</p><p><strong>Example:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/api/resource</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>method</span> = <span style=color:#e6db74>ngx.req.get_method()</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>method</span> == <span style=color:#e6db74>&#34;GET&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Handling</span> <span style=color:#e6db74>GET</span> <span style=color:#e6db74>request&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>method</span> == <span style=color:#e6db74>&#34;POST&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Handling</span> <span style=color:#e6db74>POST</span> <span style=color:#e6db74>request&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>method</span> == <span style=color:#e6db74>&#34;PUT&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Handling</span> <span style=color:#e6db74>PUT</span> <span style=color:#e6db74>request&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>method</span> == <span style=color:#e6db74>&#34;DELETE&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Handling</span> <span style=color:#e6db74>DELETE</span> <span style=color:#e6db74>request&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>else</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.status</span> = <span style=color:#ae81ff>405</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Method</span> <span style=color:#e6db74>Not</span> <span style=color:#e6db74>Allowed&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h2 id=working-with-lua-in-openresty>Working with Lua in OpenResty<a hidden class=anchor aria-hidden=true href=#working-with-lua-in-openresty>#</a></h2><h3 id=lua-modules-and-libraries>Lua Modules and Libraries<a hidden class=anchor aria-hidden=true href=#lua-modules-and-libraries>#</a></h3><p>Leverage Lua modules to organize and reuse code.</p><p><strong>Example: Creating a Lua Module (<code>/usr/local/openresty/lualib/my_module.lua</code>):</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- my_module.lua</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> _M <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_M</span>.<span style=color:#a6e22e>greet</span>(name)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Hello, &#34;</span> <span style=color:#f92672>..</span> name <span style=color:#f92672>..</span> <span style=color:#e6db74>&#34;!&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> _M
</span></span></code></pre></div><p><strong>Using the Module in Nginx Configuration:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/greet</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>default_type</span> <span style=color:#e6db74>&#39;text/plain&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>my_module</span> = <span style=color:#e6db74>require</span> <span style=color:#e6db74>&#34;my_module&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>message</span> = <span style=color:#e6db74>my_module.greet(&#34;OpenResty&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.say(message)</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=impact-of-luajit>Impact of LuaJIT<a hidden class=anchor aria-hidden=true href=#impact-of-luajit>#</a></h3><p>LuaJIT is a Just-In-Time Compiler for Lua, providing significant performance improvements.</p><ul><li><p><strong>Benefits:</strong></p><ul><li><strong>Speed:</strong> Lua code runs at speeds comparable to C.</li><li><strong>Efficiency:</strong> Enables writing high-performance applications without sacrificing ease of development.</li><li><strong>Memory Management:</strong> Efficient memory usage, crucial for high-concurrency environments.</li></ul></li><li><p><strong>Considerations:</strong></p><ul><li><strong>Compatibility:</strong> Ensure LuaJIT is compatible with the Lua code and libraries you intend to use.</li><li><strong>Limitations:</strong> Certain Lua features might be less efficient or unsupported; refer to LuaJIT documentation for specifics.</li></ul></li></ul><h2 id=interacting-with-databases>Interacting with Databases<a hidden class=anchor aria-hidden=true href=#interacting-with-databases>#</a></h2><p>OpenResty seamlessly integrates with databases using Lua libraries.</p><h3 id=connecting-to-mysql>Connecting to MySQL<a hidden class=anchor aria-hidden=true href=#connecting-to-mysql>#</a></h3><p>Use the <code>lua-resty-mysql</code> library to interact with MySQL databases.</p><p><strong>Installation:</strong></p><p>Ensure you have LuaRocks installed, then install the library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo luarocks install lua-resty-mysql
</span></span></code></pre></div><p><strong>Configuration Example:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/users</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>mysql</span> = <span style=color:#e6db74>require</span> <span style=color:#e6db74>&#34;resty.mysql&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>db,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>mysql:new()</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>db</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>instantiate</span> <span style=color:#e6db74>mysql:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>db:set_timeout(1000)</span> <span style=color:#e6db74>--</span> <span style=color:#ae81ff>1</span> <span style=color:#e6db74>sec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>ok,</span> <span style=color:#e6db74>err,</span> <span style=color:#e6db74>errno,</span> <span style=color:#e6db74>sqlstate</span> = <span style=color:#e6db74>db:connect</span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>host</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>port</span> = <span style=color:#ae81ff>3306</span><span style=color:#e6db74>,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>database</span> = <span style=color:#e6db74>&#34;test_db&#34;,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>user</span> = <span style=color:#e6db74>&#34;test_user&#34;,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>password</span> = <span style=color:#e6db74>&#34;test_pass&#34;,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>charset</span> = <span style=color:#e6db74>&#34;utf8&#34;,</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>max_packet_size</span> = <span style=color:#ae81ff>1048576</span><span style=color:#e6db74>,</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>ok</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>connect:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err,</span> <span style=color:#e6db74>&#34;:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>errno,</span> <span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>sqlstate)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>res,</span> <span style=color:#e6db74>err,</span> <span style=color:#e6db74>errno,</span> <span style=color:#e6db74>sqlstate</span> = <span style=color:#e6db74>db:query(&#34;SELECT</span> <span style=color:#e6db74>*</span> <span style=color:#e6db74>FROM</span> <span style=color:#e6db74>users&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>res</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Bad</span> <span style=color:#e6db74>result:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err,</span> <span style=color:#e6db74>&#34;:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>errno,</span> <span style=color:#e6db74>&#34;:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>sqlstate,</span> <span style=color:#e6db74>&#34;.&#34;)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Put</span> <span style=color:#e6db74>it</span> <span style=color:#e6db74>into</span> <span style=color:#e6db74>the</span> <span style=color:#e6db74>connection</span> <span style=color:#e6db74>pool</span> <span style=color:#e6db74>of</span> <span style=color:#e6db74>size</span> <span style=color:#ae81ff>100</span><span style=color:#e6db74>,</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>with</span> <span style=color:#ae81ff>10</span> <span style=color:#e6db74>seconds</span> <span style=color:#e6db74>max</span> <span style=color:#e6db74>idle</span> <span style=color:#e6db74>time</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>ok,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>db:set_keepalive(10000,</span> <span style=color:#ae81ff>100</span><span style=color:#e6db74>)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>ok</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>set</span> <span style=color:#e6db74>keepalive:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.say(vim.inspect(res))</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p><strong>Explanation:</strong></p><ol><li><strong>Instantiate MySQL Object:</strong> Create a new MySQL instance.</li><li><strong>Set Timeout:</strong> Define a timeout for the connection.</li><li><strong>Connect to Database:</strong> Provide necessary connection parameters.</li><li><strong>Execute Query:</strong> Perform SQL queries and handle results.</li><li><strong>Connection Pooling:</strong> Use <code>set_keepalive</code> to reuse connections.</li></ol><h3 id=connecting-to-redis>Connecting to Redis<a hidden class=anchor aria-hidden=true href=#connecting-to-redis>#</a></h3><p>Use the <code>lua-resty-redis</code> library to interact with Redis.</p><p><strong>Installation:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo luarocks install lua-resty-redis
</span></span></code></pre></div><p><strong>Configuration Example:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/cache</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>redis</span> = <span style=color:#e6db74>require</span> <span style=color:#e6db74>&#34;resty.redis&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>red</span> = <span style=color:#e6db74>redis:new()</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>red:set_timeout(1000)</span> <span style=color:#e6db74>--</span> <span style=color:#ae81ff>1</span> <span style=color:#e6db74>sec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>ok,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:connect(&#34;127.0.0.1&#34;,</span> <span style=color:#ae81ff>6379</span><span style=color:#e6db74>)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>ok</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>connect:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Optional:</span> <span style=color:#e6db74>authenticate</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>res,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:auth(&#34;your_password&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>res</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>authenticate:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Set</span> <span style=color:#e6db74>a</span> <span style=color:#e6db74>key</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ok,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:set(&#34;my_key&#34;,</span> <span style=color:#e6db74>&#34;Hello,</span> <span style=color:#e6db74>Redis!&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>ok</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>set</span> <span style=color:#e6db74>key:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Get</span> <span style=color:#e6db74>the</span> <span style=color:#e6db74>key</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>res,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:get(&#34;my_key&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>res</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>get</span> <span style=color:#e6db74>key:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>res</span> == <span style=color:#e6db74>ngx.null</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Key</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>found.&#34;)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.say(&#34;Retrieved</span> <span style=color:#e6db74>from</span> <span style=color:#e6db74>Redis:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>res)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Put</span> <span style=color:#e6db74>it</span> <span style=color:#e6db74>into</span> <span style=color:#e6db74>the</span> <span style=color:#e6db74>connection</span> <span style=color:#e6db74>pool</span> <span style=color:#e6db74>of</span> <span style=color:#e6db74>size</span> <span style=color:#ae81ff>100</span><span style=color:#e6db74>,</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>with</span> <span style=color:#ae81ff>10</span> <span style=color:#e6db74>seconds</span> <span style=color:#e6db74>max</span> <span style=color:#e6db74>idle</span> <span style=color:#e6db74>time</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>ok,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:set_keepalive(10000,</span> <span style=color:#ae81ff>100</span><span style=color:#e6db74>)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>ok</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>set</span> <span style=color:#e6db74>keepalive:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p><strong>Explanation:</strong></p><ol><li><strong>Instantiate Redis Object:</strong> Create a new Redis instance.</li><li><strong>Set Timeout:</strong> Define a timeout for the connection.</li><li><strong>Connect to Redis Server:</strong> Provide Redis server address and port.</li><li><strong>Authenticate (Optional):</strong> Authenticate if Redis requires a password.</li><li><strong>Execute Commands:</strong> Perform Redis commands like <code>SET</code> and <code>GET</code>.</li><li><strong>Connection Pooling:</strong> Reuse connections using <code>set_keepalive</code>.</li></ol><h2 id=caching-strategies>Caching Strategies<a hidden class=anchor aria-hidden=true href=#caching-strategies>#</a></h2><p>Implementing effective caching strategies can significantly enhance your application&rsquo;s performance.</p><h3 id=using-lua-for-caching>Using Lua for Caching<a hidden class=anchor aria-hidden=true href=#using-lua-for-caching>#</a></h3><p>Store frequently accessed data in memory to reduce database load.</p><p><strong>Example: Caching User Data</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/user</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>redis</span> = <span style=color:#e6db74>require</span> <span style=color:#e6db74>&#34;resty.redis&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>cjson</span> = <span style=color:#e6db74>require</span> <span style=color:#e6db74>&#34;cjson&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>red</span> = <span style=color:#e6db74>redis:new()</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>red:set_timeout(1000)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Connect</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>Redis</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>ok,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:connect(&#34;127.0.0.1&#34;,</span> <span style=color:#ae81ff>6379</span><span style=color:#e6db74>)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>ok</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>connect</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>Redis:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.exit(500)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Try</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>get</span> <span style=color:#e6db74>user</span> <span style=color:#e6db74>data</span> <span style=color:#e6db74>from</span> <span style=color:#e6db74>Redis</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>user_id</span> = <span style=color:#e6db74>ngx.var.arg_id</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>user_id</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;User</span> <span style=color:#e6db74>ID</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>provided&#34;)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>res,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:get(&#34;user:&#34;</span> <span style=color:#e6db74>..</span> <span style=color:#e6db74>user_id)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>res</span> == <span style=color:#e6db74>ngx.null</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>--</span> <span style=color:#e6db74>Data</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>in</span> <span style=color:#e6db74>cache,</span> <span style=color:#e6db74>fetch</span> <span style=color:#e6db74>from</span> <span style=color:#e6db74>database</span> <span style=color:#e6db74>(simulated)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>local</span> <span style=color:#e6db74>user_data</span> = {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>id</span> = <span style=color:#e6db74>user_id,</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>name</span> = <span style=color:#e6db74>&#34;John</span> <span style=color:#e6db74>Doe&#34;,</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>email</span> = <span style=color:#e6db74>&#34;john.doe@example.com&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>--</span> <span style=color:#e6db74>Simulate</span> <span style=color:#e6db74>database</span> <span style=color:#e6db74>delay</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.sleep(0.1)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>--</span> <span style=color:#e6db74>Store</span> <span style=color:#e6db74>in</span> <span style=color:#e6db74>Redis</span> <span style=color:#e6db74>with</span> <span style=color:#e6db74>TTL</span> <span style=color:#e6db74>of</span> <span style=color:#ae81ff>60</span> <span style=color:#e6db74>seconds</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>red:setex(&#34;user:&#34;</span> <span style=color:#e6db74>..</span> <span style=color:#e6db74>user_id,</span> <span style=color:#ae81ff>60</span><span style=color:#e6db74>,</span> <span style=color:#e6db74>cjson.encode(user_data))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(cjson.encode(user_data))</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>else</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>--</span> <span style=color:#e6db74>Data</span> <span style=color:#e6db74>found</span> <span style=color:#e6db74>in</span> <span style=color:#e6db74>cache</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(res)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Set</span> <span style=color:#e6db74>keepalive</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>ok,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>red:set_keepalive(10000,</span> <span style=color:#ae81ff>100</span><span style=color:#e6db74>)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>ok</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>set</span> <span style=color:#e6db74>keepalive:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p><strong>Explanation:</strong></p><ol><li><strong>Attempt to Retrieve Data from Redis:</strong> Check if user data is present in the Redis cache.</li><li><strong>Fetch from Database if Cache Miss:</strong> If not found, retrieve from the database (simulated here).</li><li><strong>Store Fetched Data in Redis:</strong> Cache the retrieved data with an expiration time (<code>TTL</code>).</li><li><strong>Respond to Client:</strong> Return the user data, either from cache or database.</li></ol><h3 id=utilizing-nginx-caching>Utilizing Nginx Caching<a hidden class=anchor aria-hidden=true href=#utilizing-nginx-caching>#</a></h3><p>Leverage Nginx&rsquo;s built-in caching mechanisms for static and dynamic content.</p><p><strong>Example: Caching Responses with <code>proxy_cache</code></strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_cache_path</span> <span style=color:#e6db74>/var/cache/nginx</span> <span style=color:#e6db74>levels=1:2</span> <span style=color:#e6db74>keys_zone=my_cache:10m</span> <span style=color:#e6db74>max_size=10g</span> <span style=color:#e6db74>inactive=60m</span> <span style=color:#e6db74>use_temp_path=off</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen</span> <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>server_name</span> <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/api</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>my_cache</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://backend_server</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Cache based on query parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>proxy_cache_key</span> <span style=color:#e6db74>&#34;</span>$scheme$request_method$host$request_uri&#34;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Cache validity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>302</span> <span style=color:#ae81ff>10m</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>404</span>      <span style=color:#ae81ff>1m</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Explanation:</strong></p><ol><li><strong>Define Cache Path and Zone:</strong> Configure where and how Nginx stores cached data.</li><li><strong>Enable Caching in Location Block:</strong> Apply caching to specific routes or endpoints.</li><li><strong>Set Cache Keys:</strong> Define how cache entries are identified.</li><li><strong>Specify Cache Validity:</strong> Determine how long different response statuses are cached.</li></ol><h2 id=security-best-practices>Security Best Practices<a hidden class=anchor aria-hidden=true href=#security-best-practices>#</a></h2><p>Ensuring the security of your OpenResty applications is paramount. Implement the following best practices to safeguard your applications.</p><h3 id=input-validation>Input Validation<a hidden class=anchor aria-hidden=true href=#input-validation>#</a></h3><p>Always validate and sanitize user inputs to prevent injections and other attacks.</p><p><strong>Example: Validating Query Parameters</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/search</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>args</span> = <span style=color:#e6db74>ngx.req.get_uri_args()</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>query</span> = <span style=color:#e6db74>args.query</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>query</span> <span style=color:#e6db74>or</span> <span style=color:#75715e>#query &lt; 3 then
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#e6db74>ngx.status</span> = <span style=color:#ae81ff>400</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Invalid</span> <span style=color:#e6db74>query</span> <span style=color:#e6db74>parameter&#34;)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>--</span> <span style=color:#e6db74>Proceed</span> <span style=color:#e6db74>with</span> <span style=color:#e6db74>processing</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.say(&#34;Search</span> <span style=color:#e6db74>results</span> <span style=color:#e6db74>for:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>query)</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=securing-lua-scripts>Securing Lua Scripts<a hidden class=anchor aria-hidden=true href=#securing-lua-scripts>#</a></h3><p>Restrict access to Lua scripts and handle errors gracefully.</p><p><strong>Example: Error Handling in Lua</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span>       <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span>  <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>error_page</span> <span style=color:#ae81ff>500</span> <span style=color:#ae81ff>502</span> <span style=color:#ae81ff>503</span> <span style=color:#ae81ff>504</span> <span style=color:#e6db74>/50x.html</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> = <span style=color:#e6db74>/50x.html</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>root</span>   <span style=color:#e6db74>/usr/share/nginx/html</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/data</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>status,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>pcall(function()</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>--</span> <span style=color:#e6db74>Your</span> <span style=color:#e6db74>Lua</span> <span style=color:#e6db74>code</span> <span style=color:#e6db74>here</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>error(&#34;Simulated</span> <span style=color:#e6db74>error&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>status</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Lua</span> <span style=color:#e6db74>error:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.status</span> = <span style=color:#ae81ff>500</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Internal</span> <span style=color:#e6db74>Server</span> <span style=color:#e6db74>Error&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=rate-limiting>Rate Limiting<a hidden class=anchor aria-hidden=true href=#rate-limiting>#</a></h3><p>Prevent abuse by limiting the number of requests a client can make.</p><p><strong>Example: Implementing Rate Limiting with Lua</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>lua_shared_dict</span> <span style=color:#e6db74>limits</span> <span style=color:#ae81ff>10m</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen</span> <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>server_name</span> <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/api/</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>access_by_lua_block</span> {
</span></span><span style=display:flex><span>                <span style=color:#f92672>local</span> <span style=color:#e6db74>limit</span> = <span style=color:#e6db74>require</span> <span style=color:#e6db74>&#34;resty.limit.req&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>local</span> <span style=color:#e6db74>lim,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>limit.new(&#34;limits&#34;,</span> <span style=color:#ae81ff>100</span><span style=color:#e6db74>,</span> <span style=color:#ae81ff>200</span><span style=color:#e6db74>)</span> <span style=color:#e6db74>--</span> <span style=color:#ae81ff>100</span> <span style=color:#e6db74>requests</span> <span style=color:#e6db74>per</span> <span style=color:#e6db74>second</span> <span style=color:#e6db74>with</span> <span style=color:#e6db74>burst</span> <span style=color:#e6db74>of</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>lim</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>instantiate</span> <span style=color:#e6db74>a</span> <span style=color:#e6db74>resty.limit.req</span> <span style=color:#e6db74>object:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>return</span> <span style=color:#e6db74>ngx.exit(500)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>local</span> <span style=color:#e6db74>key</span> = <span style=color:#e6db74>ngx.var.binary_remote_addr</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>local</span> <span style=color:#e6db74>delay,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>lim:incoming(key,</span> <span style=color:#e6db74>true)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>delay</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>if</span> <span style=color:#e6db74>err</span> == <span style=color:#e6db74>&#34;rejected&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>return</span> <span style=color:#e6db74>ngx.exit(429)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>limit</span> <span style=color:#e6db74>request:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>return</span> <span style=color:#e6db74>ngx.exit(500)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>if</span> <span style=color:#e6db74>delay</span> <span style=color:#e6db74>&gt;=</span> <span style=color:#ae81ff>0</span><span style=color:#e6db74>.001</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>ngx.sleep(delay)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>proxy_pass</span> <span style=color:#e6db74>http://backend_server</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Explanation:</strong></p><ol><li><strong>Define Shared Dictionary:</strong> Allocate shared memory for storing rate-limiting data.</li><li><strong>Instantiate Rate Limiter:</strong> Use <code>resty.limit.req</code> to set request limits.</li><li><strong>Identify Clients:</strong> Use client’s IP address as the identifier.</li><li><strong>Enforce Limits:</strong> Allow or reject requests based on defined thresholds.</li></ol><h2 id=performance-optimization>Performance Optimization<a hidden class=anchor aria-hidden=true href=#performance-optimization>#</a></h2><p>Optimize your OpenResty applications to handle high traffic efficiently.</p><h3 id=efficient-lua-coding>Efficient Lua Coding<a hidden class=anchor aria-hidden=true href=#efficient-lua-coding>#</a></h3><p>Write optimized Lua code to reduce execution time and memory usage.</p><p><strong>Example: Avoiding Unnecessary Table Creations</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- Inefficient</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>generate_users</span>(n)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, n <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        users[i] <span style=color:#f92672>=</span> {id <span style=color:#f92672>=</span> i, name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;User&#34;</span> <span style=color:#f92672>..</span> i}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> users
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- Efficient</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>generate_users</span>(n)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> users <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, n <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        users[i] <span style=color:#f92672>=</span> {id <span style=color:#f92672>=</span> i, name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;User&#34;</span> <span style=color:#f92672>..</span> i}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> users
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>(Note: The above example shows a common pattern; optimize further as needed.)</p><h3 id=nginx-optimization>Nginx Optimization<a hidden class=anchor aria-hidden=true href=#nginx-optimization>#</a></h3><p>Tweak Nginx settings for better performance.</p><p><strong>Example: Increasing Worker Connections</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>worker_processes</span> <span style=color:#e6db74>auto</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>events</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>worker_connections</span> <span style=color:#ae81ff>4096</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>multi_accept</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Explanation:</strong></p><ul><li><strong><code>worker_processes auto</code>:</strong> Automatically sets the number of worker processes based on available CPU cores.</li><li><strong><code>worker_connections</code>:</strong> Increases the number of simultaneous connections each worker can handle.</li><li><strong><code>multi_accept on</code>:</strong> Workers accept all new connections at once, improving connection handling under heavy load.</li></ul><h2 id=debugging-and-logging>Debugging and Logging<a hidden class=anchor aria-hidden=true href=#debugging-and-logging>#</a></h2><p>Effective debugging and logging are essential for maintaining and troubleshooting applications.</p><h3 id=setting-up-logging>Setting Up Logging<a hidden class=anchor aria-hidden=true href=#setting-up-logging>#</a></h3><p>Configure Nginx and Lua to log important events and errors.</p><p><strong>Nginx Logging Configuration:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>log_format</span> <span style=color:#e6db74>main</span> <span style=color:#e6db74>&#39;</span>$remote_addr <span style=color:#e6db74>-</span> $remote_user <span style=color:#e6db74>[</span>$time_local] <span style=color:#e6db74>&#34;</span>$request&#34; <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;</span>$status $body_bytes_sent <span style=color:#e6db74>&#34;</span>$http_referer&#34; <span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;&#34;</span>$http_user_agent&#34; <span style=color:#e6db74>&#34;</span>$http_x_forwarded_for&#34;&#39;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/access.log</span> <span style=color:#e6db74>main</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>error_log</span> <span style=color:#e6db74>/var/log/nginx/error.log</span> <span style=color:#e6db74>warn</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen</span> <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>server_name</span> <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>                <span style=color:#f92672>ngx.log(ngx.INFO,</span> <span style=color:#e6db74>&#34;Handling</span> <span style=color:#e6db74>request</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>/&#34;)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.say(&#34;Hello,</span> <span style=color:#e6db74>OpenResty!&#34;)</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><p><strong>Lua Logging:</strong></p><p>Use <code>ngx.log</code> to log messages at various levels (DEBUG, INFO, WARN, ERR, etc.).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>ngx.log(ngx.INFO, <span style=color:#e6db74>&#34;This is an informational message&#34;</span>)
</span></span><span style=display:flex><span>ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;This is an error message&#34;</span>)
</span></span></code></pre></div><h3 id=debugging-lua-scripts>Debugging Lua Scripts<a hidden class=anchor aria-hidden=true href=#debugging-lua-scripts>#</a></h3><p>Use LuaJIT’s built-in debugging tools and external libraries.</p><p><strong>Using <code>debug</code> Library:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>content_by_lua_block {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>faulty_function</span>()
</span></span><span style=display:flex><span>        error(<span style=color:#e6db74>&#34;Something went wrong!&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> status, err <span style=color:#f92672>=</span> pcall(faulty_function)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> status <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ngx.log(ngx.ERR, <span style=color:#e6db74>&#34;Error: &#34;</span>, err)
</span></span><span style=display:flex><span>        ngx.status <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>
</span></span><span style=display:flex><span>        ngx.say(<span style=color:#e6db74>&#34;Internal Server Error&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>External Libraries:</strong></p><ul><li><strong>Lua Inspect:</strong> For inspecting variables and data structures.</li><li><strong>Mobdebug:</strong> For remote debugging with zero-brain.</li></ul><p><strong>Example: Remote Debugging with Mobdebug</strong></p><ol><li><p><strong>Install Mobdebug:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>luarocks install mobdebug
</span></span></code></pre></div></li><li><p><strong>Configure Lua Code:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>content_by_lua_block {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> mobdebug <span style=color:#f92672>=</span> require <span style=color:#e6db74>&#34;mobdebug&#34;</span>
</span></span><span style=display:flex><span>    mobdebug.listen() <span style=color:#75715e>-- Wait for debugger to connect</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- Your Lua code here</span>
</span></span><span style=display:flex><span>    ngx.say(<span style=color:#e6db74>&#34;Debugging OpenResty with Mobdebug&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><strong>Connect Debugger:</strong></p><p>Use an IDE like ZeroBrane Studio to connect to Mobdebug.</p></li></ol><h2 id=deployment>Deployment<a hidden class=anchor aria-hidden=true href=#deployment>#</a></h2><p>Deploy OpenResty applications efficiently to production environments.</p><h3 id=preparing-for-production>Preparing for Production<a hidden class=anchor aria-hidden=true href=#preparing-for-production>#</a></h3><ol><li><p><strong>Optimize Configuration:</strong></p><ul><li>Disable unnecessary modules and logging.</li><li>Fine-tune worker processes and connections.</li></ul></li><li><p><strong>Secure the Server:</strong></p><ul><li>Use HTTPS with TLS certificates.</li><li>Implement firewall rules and security groups.</li></ul></li><li><p><strong>Test Thoroughly:</strong></p><ul><li>Perform load testing and stress testing.</li><li>Ensure all functionalities work as expected.</li></ul></li></ol><h3 id=managing-configuration>Managing Configuration<a hidden class=anchor aria-hidden=true href=#managing-configuration>#</a></h3><p>Use environment variables and separate configuration files for different environments.</p><p><strong>Example: Using Environment Variables in Lua</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>content_by_lua_block {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> db_host <span style=color:#f92672>=</span> os.getenv(<span style=color:#e6db74>&#34;DB_HOST&#34;</span>) <span style=color:#f92672>or</span> <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> db_port <span style=color:#f92672>=</span> tonumber(os.getenv(<span style=color:#e6db74>&#34;DB_PORT&#34;</span>)) <span style=color:#f92672>or</span> <span style=color:#ae81ff>3306</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ngx.say(<span style=color:#e6db74>&#34;Database Host: &#34;</span>, db_host)
</span></span><span style=display:flex><span>    ngx.say(<span style=color:#e6db74>&#34;Database Port: &#34;</span>, db_port)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=continuous-integration-and-deployment-cicd>Continuous Integration and Deployment (CI/CD)<a hidden class=anchor aria-hidden=true href=#continuous-integration-and-deployment-cicd>#</a></h3><p>Automate the build, test, and deployment processes using CI/CD tools.</p><p><strong>Example: GitLab CI Configuration (<code>.gitlab-ci.yml</code>):</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;Building OpenResty application...&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#75715e># Add build commands here</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>artifacts</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>paths</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>build/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>test</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;Running tests...&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#75715e># Add test commands here</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>deploy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;Deploying to production...&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ssh user@server &#34;sudo systemctl restart openresty&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master</span>
</span></span></code></pre></div><h2 id=advanced-topics>Advanced Topics<a hidden class=anchor aria-hidden=true href=#advanced-topics>#</a></h2><h3 id=microservices-with-openresty>Microservices with OpenResty<a hidden class=anchor aria-hidden=true href=#microservices-with-openresty>#</a></h3><p>Leverage OpenResty for building microservices architectures.</p><p><strong>Key Considerations:</strong></p><ul><li><strong>Service Isolation:</strong> Each microservice should handle a specific functionality.</li><li><strong>Inter-Service Communication:</strong> Use HTTP/HTTPS, gRPC, or message queues (e.g., Kafka) for communication between services.</li><li><strong>Service Discovery:</strong> Implement service discovery mechanisms to manage dynamic service instances.</li><li><strong>Load Balancing:</strong> Utilize Nginx&rsquo;s load balancing features or service meshes like Istio.</li></ul><p><strong>Example: Building a Simple Microservice</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/service1</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>--</span> <span style=color:#e6db74>Service</span> <span style=color:#ae81ff>1</span> <span style=color:#e6db74>logic</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.say(&#34;Response</span> <span style=color:#e6db74>from</span> <span style=color:#e6db74>Service</span> <span style=color:#ae81ff>1</span><span style=color:#e6db74>&#34;)</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>location</span> <span style=color:#e6db74>/service2</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>--</span> <span style=color:#e6db74>Service</span> <span style=color:#ae81ff>2</span> <span style=color:#e6db74>logic</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>ngx.say(&#34;Response</span> <span style=color:#e6db74>from</span> <span style=color:#e6db74>Service</span> <span style=color:#ae81ff>2</span><span style=color:#e6db74>&#34;)</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h3 id=websockets-integration>WebSockets Integration<a hidden class=anchor aria-hidden=true href=#websockets-integration>#</a></h3><p>Enable real-time communication using WebSockets.</p><p><strong>Example: Handling WebSockets with Lua</strong></p><ol><li><p><strong>Install lua-resty-websocket:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo luarocks install lua-resty-websocket
</span></span></code></pre></div></li><li><p><strong>Configuration:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>location</span> <span style=color:#e6db74>/ws</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>content_by_lua_block</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>local</span> <span style=color:#e6db74>websocket</span> = <span style=color:#e6db74>require</span> <span style=color:#e6db74>&#34;resty.websocket.server&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>local</span> <span style=color:#e6db74>wb,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>websocket:new</span>{
</span></span><span style=display:flex><span>                <span style=color:#f92672>timeout</span> = <span style=color:#ae81ff>5000</span><span style=color:#e6db74>,</span>  <span style=color:#e6db74>--</span> <span style=color:#e6db74>in</span> <span style=color:#e6db74>milliseconds</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>max_payload_len</span> = <span style=color:#ae81ff>65535</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>wb</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>new</span> <span style=color:#e6db74>websocket:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>return</span> <span style=color:#e6db74>ngx.exit(444)</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>while</span> <span style=color:#e6db74>true</span> <span style=color:#e6db74>do</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>local</span> <span style=color:#e6db74>data,</span> <span style=color:#e6db74>typ,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>wb:recv_frame()</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>data</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>if</span> <span style=color:#e6db74>err</span> ~<span style=color:#e6db74>=</span> <span style=color:#e6db74>&#34;timeout&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>receive</span> <span style=color:#e6db74>frame:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>wb:send_close(1002,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>receive</span> <span style=color:#e6db74>frame&#34;)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>if</span> <span style=color:#e6db74>typ</span> == <span style=color:#e6db74>&#34;close&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>local</span> <span style=color:#e6db74>bytes,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>wb:send_close(1000)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>bytes</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>send</span> <span style=color:#e6db74>close:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>typ</span> == <span style=color:#e6db74>&#34;ping&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>local</span> <span style=color:#e6db74>bytes,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>wb:send_pong()</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>bytes</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>send</span> <span style=color:#e6db74>pong:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>typ</span> == <span style=color:#e6db74>&#34;pong&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>--</span> <span style=color:#e6db74>handle</span> <span style=color:#e6db74>pong</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>typ</span> == <span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>--</span> <span style=color:#e6db74>Echo</span> <span style=color:#e6db74>the</span> <span style=color:#e6db74>received</span> <span style=color:#e6db74>message</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>local</span> <span style=color:#e6db74>bytes,</span> <span style=color:#e6db74>err</span> = <span style=color:#e6db74>wb:send_text(data)</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>if</span> <span style=color:#e6db74>not</span> <span style=color:#e6db74>bytes</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>ngx.log(ngx.ERR,</span> <span style=color:#e6db74>&#34;Failed</span> <span style=color:#e6db74>to</span> <span style=color:#e6db74>send</span> <span style=color:#e6db74>text:</span> <span style=color:#e6db74>&#34;,</span> <span style=color:#e6db74>err)</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>return</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>elseif</span> <span style=color:#e6db74>typ</span> == <span style=color:#e6db74>&#34;binary&#34;</span> <span style=color:#e6db74>then</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>--</span> <span style=color:#e6db74>Handle</span> <span style=color:#e6db74>binary</span> <span style=color:#e6db74>data</span> <span style=color:#e6db74>if</span> <span style=color:#e6db74>needed</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>end</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div></li></ol><p><strong>Explanation:</strong></p><ol><li><strong>Establish WebSocket Connection:</strong> Upgrade the HTTP request to a WebSocket connection.</li><li><strong>Handle Frames:</strong> Receive and respond to different frame types (<code>text</code>, <code>binary</code>, <code>ping</code>, <code>pong</code>, <code>close</code>).</li><li><strong>Echo Messages:</strong> Echo back received text messages for demonstration.</li></ol><h3 id=api-gateway-with-openresty>API Gateway with OpenResty<a hidden class=anchor aria-hidden=true href=#api-gateway-with-openresty>#</a></h3><p>Use OpenResty as an API Gateway to manage, route, and secure API traffic.</p><p><strong>Key Features:</strong></p><ul><li><strong>Routing and Load Balancing:</strong> Direct requests to appropriate backend services.</li><li><strong>Authentication and Authorization:</strong> Implement security measures to protect APIs.</li><li><strong>Rate Limiting:</strong> Control the rate of incoming requests.</li><li><strong>Caching and Compression:</strong> Optimize performance by caching responses and compressing data.</li></ul><p><strong>Example: Simple API Gateway Configuration</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>http</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>lua_shared_dict</span> <span style=color:#e6db74>limits</span> <span style=color:#ae81ff>10m</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>proxy_cache_path</span> <span style=color:#e6db74>/var/cache/nginx</span> <span style=color:#e6db74>levels=1:2</span> <span style=color:#e6db74>keys_zone=my_cache:10m</span> <span style=color:#e6db74>max_size=1g</span> <span style=color:#e6db74>inactive=60m</span> <span style=color:#e6db74>use_temp_path=off</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen</span> <span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>server_name</span> <span style=color:#e6db74>localhost</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/api/service1</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://service1_backend</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Caching
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>my_cache</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>302</span> <span style=color:#ae81ff>10m</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>404</span>      <span style=color:#ae81ff>1m</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>location</span> <span style=color:#e6db74>/api/service2</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://service2_backend</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $host;
</span></span><span style=display:flex><span>            <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Rate Limiting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#f92672>access_by_lua_block</span> {
</span></span><span style=display:flex><span>                <span style=color:#f92672>--</span> <span style=color:#e6db74>Implement</span> <span style=color:#e6db74>rate</span> <span style=color:#e6db74>limiting</span> <span style=color:#e6db74>logic</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>location</span> <span style=color:#e6db74>/auth</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>access_by_lua_block</span> {
</span></span><span style=display:flex><span>                <span style=color:#f92672>--</span> <span style=color:#e6db74>Implement</span> <span style=color:#e6db74>authentication</span> <span style=color:#e6db74>logic</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>proxy_pass</span> <span style=color:#e6db74>http://auth_backend</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Explanation:</strong></p><ul><li><strong>Routing:</strong> Direct API requests to respective backend services.</li><li><strong>Caching:</strong> Cache responses from <code>service1_backend</code> to improve performance.</li><li><strong>Rate Limiting:</strong> Apply rate limiting on <code>service2_backend</code>.</li><li><strong>Authentication:</strong> Add authentication checks for sensitive endpoints.</li></ul><h2 id=resources-and-further-reading>Resources and Further Reading<a hidden class=anchor aria-hidden=true href=#resources-and-further-reading>#</a></h2><h3 id=official-documentation>Official Documentation<a hidden class=anchor aria-hidden=true href=#official-documentation>#</a></h3><ul><li><strong>OpenResty Official Site:</strong> <a href=https://openresty.org/>https://openresty.org/</a></li><li><strong>OpenResty GitHub Repository:</strong> <a href=https://github.com/openresty/openresty>https://github.com/openresty/openresty</a></li><li><strong>LuaJIT Documentation:</strong> <a href=https://luajit.org/>https://luajit.org/</a></li><li><strong>lua-resty Libraries:</strong> <a href=https://github.com/openresty/lua-resty-*>https://github.com/openresty/lua-resty-*</a></li></ul><h3 id=books-and-articles>Books and Articles<a hidden class=anchor aria-hidden=true href=#books-and-articles>#</a></h3><ul><li><strong>&ldquo;OpenResty: High Performance Web Platform Using Lua&rdquo;</strong> by Jay Huang</li><li><strong>&ldquo;Programming OpenResty&rdquo;</strong> by Noel Rappin</li><li><strong>&ldquo;Mastering OpenResty&rdquo;</strong> by Dr. Mai Phan and Jay Huang</li></ul><h3 id=online-tutorials-and-courses>Online Tutorials and Courses<a hidden class=anchor aria-hidden=true href=#online-tutorials-and-courses>#</a></h3><ul><li><strong>OpenResty Tutorial by OpenResty.org:</strong> <a href=https://openresty.org/en/>https://openresty.org/en/</a></li><li><strong>OpenResty Introduction on DigitalOcean:</strong> <a href=https://www.digitalocean.com/community/tutorials/how-to-install-openresty-on-ubuntu-18-04>https://www.digitalocean.com/community/tutorials/how-to-install-openresty-on-ubuntu-18-04</a></li><li><strong>YouTube Video Tutorials:</strong><ul><li><a href="https://www.youtube.com/watch?v=example">OpenResty Course - Understanding the Basics</a></li><li><a href="https://www.youtube.com/watch?v=example">Advanced OpenResty Configurations</a></li></ul></li></ul><h3 id=community-and-support>Community and Support<a hidden class=anchor aria-hidden=true href=#community-and-support>#</a></h3><ul><li><strong>OpenResty Mailing List:</strong> Subscribe to stay updated with the latest news and updates.</li><li><strong>OpenResty Forums:</strong> Participate in discussions and seek help from the community.</li><li><strong>Stack Overflow:</strong> Tag questions with <code>openresty</code> or <code>lua</code> to get assistance.</li><li><strong>Gophers Slack:</strong> Join the <a href=https://gophers.slack.com/>Gophers Slack Workspace</a> for real-time discussions and support.</li></ul><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>OpenResty is a powerful platform that combines the robust capabilities of Nginx with the flexibility of Lua scripting. This comprehensive tutorial has walked you through the essentials of setting up, configuring, and optimizing OpenResty for various web applications. By mastering OpenResty, you can build high-performance, scalable, and secure web services tailored to your specific needs.</p><p>Remember, the key to proficiency is consistent practice and active participation in the community. Leverage the resources provided, experiment with different configurations, and contribute to open-source projects to deepen your understanding and expertise in OpenResty.</p><hr><p><em>Happy Coding!</em></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bleedkagax.github.io/tags/systemdesign/>SystemDesign</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://bleedkagax.github.io/>Kaga Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script type=module>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script><script>(function(){var e=document.querySelectorAll("pre > code.language-mermaid");e.forEach(function(e){var t,n=e.parentElement;if(!n)return;t=document.createElement("div"),t.className="mermaid",t.textContent=e.textContent||"",n.replaceWith(t)})})()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>